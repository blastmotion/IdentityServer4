machine:
  services:
    - docker

dependencies:
  override:
    - docker info
  post: 
    - docker pull nginx
    - docker build -t $AWS_ACCOUNT_ID.dkr.ecr.us-west-2.amazonaws.com/nginx-updated:$CIRCLE_SHA1 .
test:
  test:
    - docker run -d -p 8080:80 --name nginx-updated $AWS_ACCOUNT_ID.dkr.ecr.us-west-2.amazonaws.com/nginx-updated:$CIRCLE_SHA1; sleep 10
    - curl localhost:8080 
deployment: 
  dev:
    branch: dev
    commands:
      - pip install aws-cli
      - aws ecr --region us-west-2 get-login & sleep 5
      - docker push $AWS_ACCOUNT_ID.dkr.ecr.us-west-2.amazonaws.com/nginx-updated:$CIRCLE_SHA1 
